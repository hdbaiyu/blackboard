class t{constructor(){this.color="white",this.courseWareNum="",this.drawState=-1,this.isBoard=1,this.isEraser=!1,this.lastLineId=-1,this.lineId=1,this.lineSize=2,this.pointId=0,this.pointX=0,this.pointY=0,this.width=0,this.height=0}}class e{constructor({color:t="white",lineSize:e=2}={}){this.color=t,this.lineSize=e}}class s{constructor({canvas:t,context:e,drawWidth:s,drawHeight:i}={}){this.canvas=t||null,this.context=e||{},this.drawWidth=s||1e3,this.drawHeight=i||500}}export default class{constructor(i){this.version="0.0.41",this.maxPick=i||10,this.dpr=Math.ceil(window.devicePixelRatio),this.backgroundColor="transparent",this.fileUrl=!1,this.isEditor=!1,this.colors={red:"red",white:"white",green:"green"},this.pies={thin:2,normal:4,thick:8},this.state={isPortrait:!0,openFile:!1,beginPoint:{},allChunks:[],menus:[],editMenus:[{text:"放大",key:"zoomIn",className:"hyfont fangda1",visible:this.fileUrl},{text:"缩小",key:"shrink",className:"hyfont suoxiao1",visible:this.fileUrl},{text:"旋转",key:"rotate",className:"hyfont xuanzhuan",visible:this.fileUrl},{text:"画笔",key:"huabi",className:"hyfont ketang-huabi",visible:this.fileUrl},{text:"保存",key:6,className:"hyfont baocun",visible:!0}],baseMenus:[{text:"编辑",key:"edit",className:"hyfont bianji",visible:!this.fileUrl},{text:"新建",key:0,className:"hyfont xinjianyiye",visible:!this.fileUrl},{text:"上一页",key:1,className:"hyfont ketang-shangyiye",visible:!this.fileUrl},{text:"下一页",key:2,className:"hyfont ketang-xiayiye",visible:!this.fileUrl},{text:"橡皮",key:3,className:"hyfont ketang-cachu",visible:!this.fileUrl},{text:"清屏",key:4,className:"hyfont ketang-qingkong",visible:!this.fileUrl},{text:"画笔",key:5,className:"hyfont ketang-huabi",visible:!this.fileUrl},{text:"保存",key:6,className:"hyfont baocun",visible:!this.fileUrl}],penMenus:[{text:"画笔",key:5,className:"hyfont ketang-huabi"},{text:"红",key:7,value:this.colors.red,className:"span-icon icon-red"},{text:"白",key:8,value:this.colors.white,className:"span-icon icon-white"},{text:"绿",key:9,value:this.colors.green,className:"span-icon icon-green"},{text:"细",key:10,value:this.pies.thin,className:"line-icon icon-fine"},{text:"中",key:11,value:this.pies.normal,className:"line-icon icon-center"},{text:"粗",key:12,value:this.pies.thick,className:"line-icon icon-thick"},{text:"保存",key:6,className:"hyfont baocun"}],bodies:new t,lastPen:new e,board:new s,rate:1,points:[],pointsNum:0,boardlist:[],boardIndex:0,changeBard:!0,insertedImg:null},navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)?this.isMobile=!0:this.isMobile=!1,this.handleScreenDirection=this.handleScreenDirection.bind(this)}touchMove(){const t=document.getElementById("canvas");t.addEventListener("touchstart",this.canvasDown.bind(this),!1),t.addEventListener("touchmove",this.canvasMove.bind(this),!1),t.addEventListener("touchend",this.canvasUp.bind(this),!1)}initCanvas(t){const e=document.documentElement.clientWidth,s=document.documentElement.clientHeight;let i=e,a=s;this.isPC||(i=e>s?s:e,a=e>s?e:s);const n=document.getElementById("board"),o=document.getElementById("canvas"),l=o.getContext("2d");if(!t&&o.setAttribute("class","pencil"),o.setAttribute("width",i),o.setAttribute("height",a-80),o.style.height=a-80+"px",o.style.position="relative",o.style.zIndex="1",l.mozImageSmoothingEnabled=!1,l.webkitImageSmoothingEnabled=!1,l.msImageSmoothingEnabled=!1,l.imageSmoothingEnabled=!1,l.fillStyle=this.backgroundColor,l.fillRect(0,0,n.clientWidth,n.clientHeight),t)return{canvas:o,context:l};n.style.width=i+"px",n.style.height=a+"px",n.style.margin="0 auto",n.style.overflow="hidden",this.state.menus=this.state.baseMenus,this.isOpen=!1,this.maxLength=!1,Object.assign(this.state.board,{canvas:o,context:l,drawWidth:n.clientWidth,drawHeight:n.clientHeight-80}),this.state.boardlist.push(null),this.renderMenus()}closeBoard(){this.resetData()}resetData(){this.state.bodies=new t,this.state.lastPen=new e,this.state.board=new s,this.state.points=[],this.state.pointsNum=0,this.state.boardlist=[],this.state.boardIndex=0,this.state.changeBard=!0,clearTimeout(this.resizeBoard),this.fileUrl=!1;const i=document.getElementById("wareImageDiv");i&&(i.removeEventListener("touchstart",this.startMoveImg,!1),i.removeEventListener("touchmove",this.moveImg,!1))}initwh(t){const e=document.documentElement.clientWidth,s=document.documentElement.clientHeight,i=e>s?s:e,a=e>s?e:s,n=Math.abs(e-s)/2,o=`@media screen and (orientation: landscape) {body{width:${i}px;height:${a}px;transform: translate(${n}px, -${n}px) rotate(-90deg)}}`,l=document.createElement("style");l.innerHTML=o,window.document.head.appendChild(l)}handleScreenDirection(t){this.state.isPortrait=t.matches,t.matches}resetWidth(){this.resizeBoard&&clearTimeout(this.resizeBoard),this.resizeBoard=setTimeout((()=>{const t=document.getElementById("canvas"),e=document.getElementById("board");if(!t)return;this.saveCanvas();const s=e.clientWidth-10,i=e.clientHeight-80;t.setAttribute("width",s),t.setAttribute("height",i);const a=new Image;a.src=this.state.boardlist[this.state.boardIndex],a.onload=()=>{let t=1,e=a.width,n=a.height;if(a.width>s){let i=1-(a.width-s)/a.width;e=a.width*i,n=a.height*i,t=i}if(n>i){let s=1-(a.height-i)/a.height;t=s,e=a.width*s,n=a.height*s}const o=(s-a.width*t)/2||0;this.state.board.context.fillStyle=this.backgroundColor,this.state.board.context.fillRect(0,0,s,i),this.state.board.context.drawImage(a,0,0,a.width,a.height,o,0,e,n),this.saveCanvas(),clearTimeout(this.resizeBoard)}}),200)}renderMenus(){const t=document.getElementById("boardMenus"),e=document.getElementById("board");t&&e.removeChild(t);const{boardIndex:s,boardlist:i}=this.state,a=document.createElement("ul");a.setAttribute("id","boardMenus"),a.style.position="relative",a.style.zIndex="5",a.style.backgroundColor="#333",this.state.menus.map((t=>{let n=document.createElement("li"),o=document.createElement("div"),l=document.createElement("div"),h=document.createElement("span");if(o.className="item-icon",h.className=t.className,l.innerText=t.text,l.className="menu-text",o.appendChild(h),n.className="item-li","edit"===t.key){if(document.getElementById("rotateBtn"))return;const s=document.createElement("div");s.setAttribute("id","rotateBtn"),s.setAttribute("title","编辑图片");const i=document.createElement("i");return i.setAttribute("class",t.className),s.appendChild(i),s.style.position="absolute",s.style.zIndex=2,s.addEventListener("click",(()=>{this.boardTool(t.key)})),void e.appendChild(s)}0===t.key&&this.maxLength&&(n.className="item-li disabled"),1===t.key&&(1!==i.length&&0!==s||(n.className="item-li disabled")),2===t.key&&(i.length<=1&&(n.className="item-li disabled"),s===i.length-1&&(n.className="item-li disabled")),5===t.key&&(o.style=`color: ${this.state.lastPen.color}`),this.isChoosedMenu(t.key)&&(o.className+=" choosed"),n.appendChild(o),n.appendChild(l),n.addEventListener("click",(()=>{this.boardTool(t.key)})),a.appendChild(n)})),e.appendChild(a)}switchMenus(){if(this.isOpen=!this.isOpen,this.isMobile)this.isOpen?this.state.menus=this.state.penMenus:this.state.menus=this.state.baseMenus;else if(this.isOpen){const t=this.state.baseMenus.slice(0,-2);this.state.menus=[...t,...this.state.penMenus]}else this.state.menus=this.state.baseMenus}findMenuByKey(t){return this.state.menus.filter((e=>e.key===t))[0]}isChoosedMenu(t){const{bodies:e}=this.state,s=this.findMenuByKey(t);return!(3!==t||!e.isEraser)||(5===t&&!e.isEraser||(e.color===s.value||e.lineSize===s.value))}isPC(){let t=navigator.userAgent,e=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],s=!0;for(let i=0;i<e.length;i++)if(t.indexOf(e[i])>0){s=!1;break}return s}isIOS(){return!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)}handlePosition(t,e){if(!this.state.isPortrait&&"none"!==window.getComputedStyle(document.body).transform){let s=t;t=this.state.board.drawWidth-e,e=s}return{x:t,y:e}}dealPoint(t,e,s){const i=this.state.points.length;if(-1!==s&&i>0){const a=this.state.points[i-1],n={x:t,y:e},o={x:(a.x+t)/2,y:(a.y+e)/2};Object.assign(this.state.bodies,{pointId:this.state.bodies.pointId+.5,drawState:s,pointX:Math.ceil(o.x),pointY:Math.ceil(o.y)}),this.state.points.push(n),this.state.pointsNum++,Object.assign(this.state.bodies,{pointId:Math.floor(this.state.bodies.pointId)+1,pointX:t,pointY:e}),this.state.points.length>2&&(this.state.bodies.isEraser?this.eraserLine(this.state.beginPoint,a,o):this.drawLine(this.state.beginPoint,a,o),this.state.beginPoint=o)}else{let i=parseInt(this.state.bodies.lastLineId)+1;Object.assign(this.state.bodies,{pointId:0,drawState:s,pointX:t,pointY:e,lineId:i||0,lastLineId:parseInt(this.state.bodies.lastLineId)+1}),this.state.points.push({x:t,y:e}),this.state.pointsNum++,this.state.beginPoint={x:t,y:e}}}canvasDown(t){let e;this.canvasMoveUse=!0,t.stopPropagation(),t.preventDefault(),this.isOpen&&(this.state.menus=this.state.baseMenus,this.renderMenus()),this.isOpen=!1;try{t instanceof TouchEvent&&(e=!0)}catch(s){e=!1}if(e){const e=t.target.getBoundingClientRect().left,s=t.target.getBoundingClientRect().top;let i=t.touches[0].clientX-e,a=t.touches[0].clientY-s;this.dealPoint(i,a,-1)}else this.dealPoint(t.offsetX,t.offsetY,-1)}canvasMove(t){let e;t.stopPropagation(),t.preventDefault();try{t instanceof TouchEvent&&(e=!0)}catch(s){e=!1}if(e){const e=t.target.getBoundingClientRect().left,s=t.target.getBoundingClientRect().top;let i=t.touches[0].clientX-e,a=t.touches[0].clientY-s;this.dealPoint(i,a,0)}else 1===t.buttons&&this.canvasMoveUse?this.dealPoint(t.offsetX,t.offsetY,0):this.canvasMoveUse=!1}canvasUp(t){let e;t.stopPropagation(),t.preventDefault();try{t instanceof TouchEvent&&(e=!0)}catch(s){e=!1}e?this.dealPoint(this.state.bodies.pointX,this.state.bodies.pointY,1):this.dealPoint(t.offsetX,t.offsetY,1),this.canvasMoveUse=!1,this.state.pointsNum>=3e3&&this.saveCanvas((t=>{this.state.pointsNum=0})),this.points=[]}clearCanvas(){this.state.board.canvas.height=this.state.board.canvas.height;const t=document.getElementById("board");this.state.board.context.fillStyle=this.backgroundColor,this.state.board.context.fillRect(0,0,t.clientWidth,t.clientHeight)}localSaveCanvas(){this.saveCanvas();const t=this;if(this.fileUrl)return window.postMessage({type:"loading",data:!0},window.location.origin),void this.paging(0,(()=>{this.FullPageCapture().capture({dom:document.getElementById("wrapCanvas"),h2cUrl:"https://factory-pro.oss-cn-chengdu.aliyuncs.com/resouces/libs/html2canvas.js"},(function(e){t.state.boardlist[0]=e,window.postMessage({type:"imgList",data:t.state.boardlist},window.location.origin)}))}));window.postMessage({type:"imgList",data:this.state.boardlist},window.location.origin)}saveCanvas(){const{boardIndex:t}=this.state,e=this.state.board.canvas.toDataURL("image/png",1);this.state.boardlist.splice(t,1,e)}createBoard(){if(this.state.boardlist.length>=this.maxPick)return this.maxLength=!0,void window.postMessage({type:"maxLength",data:!0},window.location.origin);document.getElementById("wareImage")&&(document.getElementById("wareImage").style.display="none",document.getElementById("rotateBtn").style.display="none"),this.state.changeBard=!0,this.saveCanvas(),this.state.boardIndex++,this.state.boardlist.splice(this.state.boardIndex,0,null),this.clearCanvas()}paging(t,e){const{boardIndex:s}=this.state;if(!(s<=0&&1===t||s>=this.state.boardlist.length-1&&2===t)){if(0===t){document.getElementById("wareImage").style.display="block";const t=new Image;return t.src=this.state.boardlist[0],void(t.onload=()=>{this.clearCanvas(),this.state.board.context.drawImage(t,0,0,t.width,t.height),e&&e()})}if(document.getElementById("wareImage")&&(document.getElementById("wareImage").style.display="none",document.getElementById("rotateBtn").style.display="none"),1===t){this.state.changeBard=!1,this.saveCanvas(),this.state.boardIndex--;const t=new Image;return t.src=this.state.boardlist[this.state.boardIndex],t.onload=()=>{this.clearCanvas(),this.state.board.context.drawImage(t,0,0,t.width,t.height)},void(this.fileUrl&&(document.getElementById("wareImage").style.display=0===this.state.boardIndex?"block":"none",document.getElementById("rotateBtn").style.display=0===this.state.boardIndex?"flex":"none"))}if(2===t){this.state.changeBard=!1,this.saveCanvas(),this.state.boardIndex++;const t=new Image;t.src=this.state.boardlist[this.state.boardIndex],t.onload=()=>{this.clearCanvas(),this.state.board.context.drawImage(t,0,0,t.width,t.height)}}}}eraserLine(t,e,s){this.state.board.context.save(),this.state.board.context.beginPath(),this.state.board.context.clearRect(e.x,e.y,this.state.bodies.lineSize,this.state.bodies.lineSize)}drawLine(t,e,s){this.setCanvasStyle(this.state.bodies.lineSize,2,this.state.bodies.color,this.state.bodies.color),this.state.board.context.beginPath(),this.state.board.context.moveTo(t.x,t.y),this.state.board.context.quadraticCurveTo(e.x,e.y,s.x,s.y),this.state.board.context.stroke(),this.state.board.context.closePath()}setCanvasStyle(t,e,s,i){this.state.board.context.globalCompositeOperation="source-over",this.state.board.context.lineCap="round",this.state.board.context.lineJoin="round",this.state.board.context.lineWidth=t,this.state.board.context.shadowBlur=e,this.state.board.context.shadowColor=s,this.state.board.context.strokeStyle=i}setColor(t){this.state.bodies.color=t}getColor(){return this.state.bodies.isEraser?"transparent":this.state.bodies.color}usePen(){this.state.bodies.isEraser=!1,this.state.bodies.lineSize=this.state.lastPen.lineSize,this.setColor(this.state.lastPen.color),document.getElementById("canvas").setAttribute("class","pencil")}useEraser(){this.state.bodies.isEraser=!0,this.state.bodies.lineSize=Math.max(5*this.state.lastPen.lineSize,20),document.getElementById("canvas").setAttribute("class","eraser")}setLastPen(){Object.assign(this.state.lastPen,{color:this.state.bodies.color,lineSize:this.state.bodies.lineSize})}base64Img(t){return window.URL=window.URL||window.webkitURL,new Promise(((e,s)=>{let i=new XMLHttpRequest;i.open("get",t+`?t=${(new Date).getTime()}`,!0),i.responseType="blob",i.onload=function(){if(200===this.status){const t=this.response;let i=new FileReader;i.onloadend=function(t){let i=t.target.result;i.length?e(i):s(i)},i.readAsDataURL(t)}},i.onerror=function(t){s("image load error")},i.send()}))}openImage(t){this.fileUrl=!0,this.state.menus=this.state.editMenus,this.renderMenus(),window.postMessage({type:"loading",data:!0},window.location.origin),this.base64Img(t.fileUrl).then((t=>{window.postMessage({type:"loading",data:!1},window.location.origin),this.state.board.context&&(document.getElementById("rotateBtn").style.display="flex",this.setColor(this.colors.red),this.state.lastPen.color=this.colors.red,this.insterImagetoView(t),this.state.changeBard=!1,this.saveCanvas())})).catch((t=>{window.postMessage({type:"error",data:!1},window.location.origin)}));let e=document.createElement("script");e.setAttribute("src","https://factory-pro.oss-cn-chengdu.aliyuncs.com/resouces/libs/html2canvas.js"),document.head.appendChild(e)}insterImagetoView(t){const e=document.getElementById("wareImage");if(e)return void(e.src=t);const s=document.getElementById("wrapCanvas"),i=document.createElement("div"),a=document.createElement("div"),{canvas:n}=this.state.board;i.setAttribute("id","wareImageDiv"),a.setAttribute("id","wareImage"),i.style.position="absolute",a.style.backgroundImage=`url(${t})`,i.style.top="0px",i.style.left=0,a.style.width="100%",a.style.height="100%",i.style.width=n.width+"px",i.style.height=n.height+"px",a.style.backgroundSize="contain",a.style.backgroundPosition="center",i.style.zIndex="2",a.style.transform="rotate(0deg) scale(1)",a.style.backgroundRepeat="no-repeat",s.style.width=n.width+"px",s.style.height=n.height+"px",a.style.position="relative",a.style.userSelect="none",this.isPC()?a.addEventListener("mousedown",this.putDown.bind(this),!1):(i.addEventListener("touchstart",this.startMoveImg.bind(this),!1),i.addEventListener("touchmove",this.moveImg.bind(this),!1)),i.appendChild(a),s.appendChild(i)}startMoveImg(t){const e=document.getElementById("wareImage");if(this.delayX=this.pageX?e.offsetLeft:0,this.delayY=this.pageY?e.offsetTop:0,this.isPC())return this.pageX=t.pageX,void(this.pageY=t.pageY);this.pageX=t.touches[0].pageX,this.pageY=t.touches[0].pageY}moveImg(t){const e=document.getElementById("wareImage");let s,i;this.isPC()?(s=t.pageX-this.pageX+this.delayX,i=t.pageY-this.pageY+this.delayY):(s=t.touches[0].pageX-this.pageX+this.delayX,i=t.touches[0].pageY-this.pageY+this.delayY),e.style.top=`${i}px`,e.style.left=`${s}px`}moveEndImg(t){}putDown(t){const e=document.getElementById("wareImageDiv");e.style.cursor="move";let s=parseInt(e.style.left),i=parseInt(e.style.top),a=t.clientX-s,n=t.clientY-i;this.isStartMoving=!0,e.onmousemove=t=>{this.isStartMoving&&(e.style.left=t.clientX-a+"px",e.style.top=t.clientY-n+"px")},e.onmouseup=t=>{this.isStartMoving=!1,e.onmousemove=null,e.onmouseup=null}}editState(t){const e=document.getElementById("wareImageDiv");this.state.menus=this.state.editMenus,e.style.zIndex=t||"2",this.renderMenus()}rotateImage(){const t=document.getElementById("wareImage"),e=t.style.transform.split(" ");let s=e[0].match(/\d+/g);const i=e[1].match(/\d+(\.\d)?/g);let a=Number(s[0]);a>=360&&(a=0),t.style.transform=`rotate(${a+90}deg) scale(${i})`}zoomImage(t){const e=document.getElementById("wareImage"),s=e.style.transform.split(" ");let i=s[0].match(/\d+/g),a=s[1].match(/\d+(\.\d)?/g);if(a[0]>=10&&t)return;const n=Number(a[0]||1);let o;o=1===t?Math.min(n+.2,10):Math.max(.2,n-.2),e.style.transform=`rotate(${i[0]}deg) scale(${o})`}boardTool(t){const e=this.findMenuByKey(t);switch(t){case"edit":{const t=document.getElementById("wareImageDiv");this.isEditor=!0,this.state.menus=this.state.editMenus,t.style.zIndex=2;break}case"huabi":{const t=document.getElementById("wareImageDiv");this.isEditor=!1,this.state.menus=this.state.baseMenus,t.style.zIndex=0;break}case"rotate":return void this.rotateImage();case"zoomIn":return void this.zoomImage(1);case"shrink":return void this.zoomImage(0);case 0:this.createBoard();break;case 1:case 2:this.paging(t);break;case 3:this.setLastPen(),this.useEraser();break;case 4:this.clearCanvas();break;case 5:this.usePen(),this.switchMenus();break;case 6:return void this.localSaveCanvas();case 7:case 8:case 9:this.setColor(e.value),this.setLastPen();break;case 10:case 11:case 12:this.state.bodies.lineSize=e.value,this.setLastPen();break;default:return}this.rendering||(this.rendering=!0,this.renderMenus(),setTimeout((()=>{this.rendering=!1}),200))}FullPageCapture(){const t=function(e,s){if(e=e||{},"function"==typeof html2canvas)try{let t=e.dom||document.body;html2canvas(t,{useCORS:!1,foreignObjectRendering:!1,allowTaint:!0,logging:!0,backgroundColor:"transparent",width:t.clientWidth,height:t.clientHeight,scrollX:0,scrollY:0,x:0,y:0,windowWidth:t.clientWidth,windowHeight:t.clientHeight}).then((function(t){e.waterMark&&(t=function(t,e){let s=t.getContext("2d");return s.font=e.font||"12px",s.fillStyle=e.color||"rgba(255,0,0,0.8)",s.fillText(e.text,e.position&&e.position.x||10,e.position&&e.position.y||10),t}(t,e.waterMark)),s&&s(t.toDataURL("image/png"))}))}catch(i){console.log("sth happened : ",i)}else!function(t,e){if("undefined"==typeof html2canvas){t&&/^http(s)?:\/\/[^\s]+$/.test(t)||(t="https://html2canvas.hertzen.com/dist/html2canvas.min.js");let s=document.createElement("script");s.setAttribute("src",t),document.head.appendChild(s);let i=window.setInterval((function(){"function"==typeof html2canvas&&(console.log("html2canvas安装成功！"),window.clearInterval(i),e&&e())}),50)}else e&&e()}(e.h2cUrl,(function(){t(e,s)}))};return{capture:t}}}
